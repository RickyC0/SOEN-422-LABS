const int REDPIN = 3;
const int YELOWPIN = 4;
const int GREENPIN = 5;

const int DIRECTION_CHANGE_PIN = 12;

int directionection = 0;
int stepIndex = 0;
unsigned long lastStepTime = 0;

const unsigned long stepDurations[] = { 2000, 1000, 500, 500 };

int lastButtonState = HIGH;

void setup() {
  pinMode(REDPIN, OUTPUT);
  pinMode(YELOWPIN, OUTPUT);
  pinMode(GREENPIN, OUTPUT);
  pinMode(DIRECTION_CHANGE_PIN, INPUT_PULLUP);
}

void setLights(int r, int y, int g) {
  digitalWrite(REDPIN, r);
  digitalWrite(YELOWPIN, y);
  digitalWrite(GREENPIN, g);
}

void showStep(int direction, int currentSate) {

 // if the state is forward aka direction ==0
    //  1 0 0 : the red is on
    //  0 1 0 : the red is on 
    //  0 0 1 : the red is on
    //  0 0 0 : all is off

    // if the state is forward aka direction ==1
    //  0 0 1 : the red is on
    //  0 1 0 : the red is on 
    //  1 0 0 : the red is on
    //  0 0 0 : all is off

  if (direction == 0) {  // right
    if (currentSate == 0) setLights(1, 0, 0);
    if (currentSate == 1) setLights(0, 1, 0);
    if (currentSate == 2) setLights(0, 0, 1);
    if (currentSate == 3) clearAllLed();
  } else {  // left
    if (currentSate == 0) setLights(0, 0, 1);
    if (currentSate == 1) setLights(0, 1, 0);
    if (currentSate == 2) setLights(1, 0, 0);
    if (currentSate == 3) clearAllLed();
  }
}

// clear LEDs immediately on toggle
void clearAllLed() {
  clearAllLed();
}

void loop() {
  int buttonState = digitalRead(DIRECTION_CHANGE_PIN);

  // check of we did press the button and reset the current state
  if (lastButtonState == HIGH && buttonState == LOW) { 
    // this will interupt the system and cancel all and switch the direction mid transition
    // we assume that this is correct 
    directionection = !directionection;
    stepIndex = 0;
    lastStepTime = millis();
  }
  lastButtonState = buttonState;

  // Step timing
  if (millis() - lastStepTime >= stepDurations[stepIndex]) {
   
    // change the current state of the board moving from red to yellow to green to nothing at all
    stepIndex += 1;
    if (stepIndex >= 4) { // make sure we are with a 4 state system s: {0,1,2,3}
      stepIndex = 0;
    }
    lastStepTime = millis();
  }

  showStep(directionection, stepIndex);
}
